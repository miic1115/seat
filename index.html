<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PaddlePlanner - 龍舟排位神器</title>
    
    <!-- 1. 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 2. 引入 Babel (用來在瀏覽器編譯 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 禁止選取文字，讓 App 操作感更像原生應用 */
        .select-none { user-select: none; -webkit-user-select: none; }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 安全區域設定 (針對 iPhone瀏海) */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components (取代 lucide-react 依賴) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ArrowUp = (p) => <IconBase {...p}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></IconBase>;
        const ArrowDown = (p) => <IconBase {...p}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></IconBase>;
        const ChevronUp = (p) => <IconBase {...p}><path d="m18 15-6-6-6 6"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ClipboardCopy = (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const Check = (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>;
        const FileSpreadsheet = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>;
        
        // --- 1. 初始資料庫 ---
        const INITIAL_ROSTER = [
            { id: "01", name: "阿翔", gender: "M", side: "L", weight: 72 },
            { id: "02", name: "小黑", gender: "M", side: "R", weight: 75 },
            { id: "03", name: "莎莎", gender: "F", side: "L", weight: 60 },
            { id: "04", name: "咪咪", gender: "F", side: "R", weight: 58 },
            { id: "05", name: "巨石", gender: "M", side: "L", weight: 98 },
            { id: "06", name: "鐵牛", gender: "M", side: "R", weight: 95 },
            { id: "07", name: "館長", gender: "M", side: "L", weight: 105 },
            { id: "08", name: "浩克", gender: "M", side: "R", weight: 102 },
            { id: "09", name: "大熊", gender: "M", side: "L", weight: 90 },
            { id: "10", name: "胖虎", gender: "M", side: "R", weight: 92 },
            { id: "11", name: "神力", gender: "F", side: "L", weight: 70 },
            { id: "12", name: "女超", gender: "F", side: "R", weight: 72 },
            { id: "13", name: "阿嘎", gender: "M", side: "L", weight: 82 },
            { id: "14", name: "小馬", gender: "M", side: "R", weight: 80 },
            { id: "15", name: "飛哥", gender: "M", side: "L", weight: 78 },
            { id: "16", name: "阿傑", gender: "M", side: "R", weight: 77 },
            { id: "17", name: "建國", gender: "M", side: "L", weight: 85 },
            { id: "18", name: "志明", gender: "M", side: "R", weight: 84 },
            { id: "19", name: "春嬌", gender: "F", side: "L", weight: 62 },
            { id: "20", "name": "阿美", gender: "F", side: "R", weight: 65 },
            { id: "21", "name": "婷婷", gender: "F", side: "L", weight: 59 },
            { id: "22", "name": "萱萱", gender: "F", side: "R", weight: 61 },
            { id: "23", "name": "老王", gender: "M", side: "L", weight: 88 },
            { id: "24", "name": "小陳", gender: "M", side: "R", weight: 86 },
            { id: "25", "name": "林董", gender: "M", side: "L", weight: 83 },
            { id: "26", "name": "張哥", gender: "M", side: "R", weight: 81 },
            { id: "27", "name": "莉莉", gender: "F", side: "L", weight: 63 },
            { id: "28", "name": "真真", gender: "F", side: "R", weight: 64 },
            { id: "29", "name": "水鬼", gender: "M", side: "L", weight: 76 },
            { id: "30", "name": "海龍", gender: "M", side: "R", weight: 75 },
            { id: "31", "name": "阿浪", gender: "M", side: "L", weight: 74 },
            { id: "32", "name": "水花", gender: "F", side: "R", weight: 66 },
            { id: "33", "name": "雙修哥", gender: "M", side: "B", weight: 80 },
            { id: "34", "name": "左右開弓", gender: "M", side: "B", weight: 78 },
            { id: "35", "name": "萬能姐", gender: "F", side: "B", weight: 65 },
            { id: "36", "name": "小隻馬", gender: "F", side: "B", weight: 55 },
            { id: "37", "name": "嬌小鼓", gender: "F", side: "B", weight: 45 },
            { id: "38", "name": "大聲公", gender: "M", side: "B", weight: 52 },
            { id: "39", "name": "老船長", gender: "M", side: "B", weight: 85 },
            { id: "40", "name": "穩舵手", gender: "M", side: "B", weight: 88 }
        ];

        const EMPTY_BOAT = {
            drummer: null,
            steers: null,
            left: Array(10).fill(null),
            right: Array(10).fill(null)
        };

        const DEFAULT_LINEUP = {
            id: 'default',
            name: '組合一',
            boat: EMPTY_BOAT
        };

        function App() {
            // --- State ---
            const [lineups, setLineups] = useState([DEFAULT_LINEUP]);
            const [activeLineupId, setActiveLineupId] = useState('default');
            const [roster, setRoster] = useState(INITIAL_ROSTER);
            
            const [isBenchOpen, setIsBenchOpen] = useState(false);
            const [selectedSource, setSelectedSource] = useState(null);
            const [isEditNameMode, setIsEditNameMode] = useState(false);
            
            // Modals
            const [deleteModalOpen, setDeleteModalOpen] = useState(false);
            const [importModalOpen, setImportModalOpen] = useState(false);
            const [copyFeedback, setCopyFeedback] = useState(false);
            
            // Import Text Area & Preview State
            const [importText, setImportText] = useState("");
            const [importPreview, setImportPreview] = useState([]);

            const currentLineup = lineups.find(l => l.id === activeLineupId) || lineups[0];
            const boat = currentLineup.boat;

            // --- Persistence ---
            useEffect(() => {
                const savedData = localStorage.getItem('paddlePlannerData_v12');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.lineups && parsed.lineups.length > 0) {
                            setLineups(parsed.lineups);
                            setActiveLineupId(parsed.activeLineupId || parsed.lineups[0].id);
                        }
                        if (parsed.roster && Array.isArray(parsed.roster)) {
                            setRoster(parsed.roster);
                        }
                    } catch (e) { console.error("Load failed", e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('paddlePlannerData_v12', JSON.stringify({ lineups, activeLineupId, roster }));
            }, [lineups, activeLineupId, roster]);

            // --- Logic: Lineup Management ---
            const updateCurrentBoat = (newBoat) => {
                setLineups(prev => prev.map(l => l.id === activeLineupId ? { ...l, boat: newBoat } : l));
            };

            const updateLineupName = (name) => {
                setLineups(prev => prev.map(l => l.id === activeLineupId ? { ...l, name } : l));
            };

            const handleAddLineup = () => {
                const newId = `lineup_${Date.now()}`;
                const newLineup = { id: newId, name: `組合 ${lineups.length + 1}`, boat: EMPTY_BOAT };
                setLineups([...lineups, newLineup]);
                setActiveLineupId(newId);
            };

            const handleDuplicateLineup = () => {
                const newId = `lineup_${Date.now()}`;
                const newLineup = {
                    id: newId,
                    name: `${currentLineup.name} (複製)`,
                    boat: JSON.parse(JSON.stringify(currentLineup.boat))
                };
                setLineups([...lineups, newLineup]);
                setActiveLineupId(newId);
            };

            const requestDeleteLineup = () => setDeleteModalOpen(true);

            const confirmDeleteLineup = () => {
                if (lineups.length <= 1) {
                    setDeleteModalOpen(false);
                    return;
                }
                const newLineups = lineups.filter(l => l.id !== activeLineupId);
                setLineups(newLineups);
                setActiveLineupId(newLineups[0].id);
                setDeleteModalOpen(false);
            };

            // --- Logic: Robust Import Parser ---
            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                const newRoster = [];
                
                lines.forEach((line, index) => {
                    if (index === 0 && (line.includes("名字") || line.includes("Name")) && !line.match(/\d/)) return;

                    const cols = line.split(/[,，、\t|;\s]+/).filter(c => c.trim() !== '');
                    if (cols.length < 2) return; 

                    const name = cols[0];
                    const restOfLine = cols.slice(1).join(' ').toLowerCase();

                    let side = 'B'; 
                    const isLeft = restOfLine.includes('左') || restOfLine.includes('left') || restOfLine.includes('l');
                    const isRight = restOfLine.includes('右') || restOfLine.includes('right') || restOfLine.includes('r');
                    const isBoth = restOfLine.includes('雙') || restOfLine.includes('both') || restOfLine.includes('b');
                    const isSteers = restOfLine.includes('舵') || restOfLine.includes('steers');
                    const isDrum = restOfLine.includes('鼓') || restOfLine.includes('drum');

                    if (isBoth || isSteers || isDrum || (isLeft && isRight)) side = 'B';
                    else if (isLeft) side = 'L';
                    else if (isRight) side = 'R';

                    let gender = 'M';
                    if (restOfLine.includes('女') || restOfLine.includes('f') || restOfLine.includes('woman') || restOfLine.includes('female')) {
                        gender = 'F';
                    }

                    const numbers = restOfLine.match(/\d+/g);
                    let weight = 0;
                    if (numbers) {
                        const likelyWeights = numbers.map(n => parseInt(n)).filter(n => n >= 20 && n <= 200);
                        weight = likelyWeights.length > 0 ? likelyWeights[likelyWeights.length - 1] : 0;
                    }

                    newRoster.push({
                        id: `imported_${Date.now()}_${index}`,
                        name,
                        side,
                        gender,
                        weight
                    });
                });

                return newRoster;
            };

            useEffect(() => {
                if (importModalOpen && importText) {
                    const parsed = parseCSV(importText);
                    setImportPreview(parsed);
                } else {
                    setImportPreview([]);
                }
            }, [importText, importModalOpen]);

            const handleImportSubmit = (mode) => {
                if (importPreview.length === 0) return;
                localStorage.setItem('paddlePlanner_backup_roster', JSON.stringify(roster));

                if (mode === 'overwrite') {
                    updateCurrentBoat(EMPTY_BOAT);
                    setRoster(importPreview);
                } else {
                    setRoster(prev => [...prev, ...importPreview]);
                }

                setImportModalOpen(false);
                setImportText("");
            };

            // --- Logic: Copy to Clipboard ---
            const handleCopyList = () => {
                let text = "";
                text += `\t鼓手：${boat.drummer ? boat.drummer.name : ''}\t\n\n`;
                text += `左舷\t右舷\n`;
                for(let i=0; i<10; i++) {
                    const leftName = boat.left[i] ? boat.left[i].name : "";
                    const rightName = boat.right[i] ? boat.right[i].name : "";
                    text += `${leftName}\t${rightName}\n`;
                }
                text += `\n\t舵手：${boat.steers ? boat.steers.name : ''}\t\n`;

                const copyToClipboardFallback = (textToCopy) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            setCopyFeedback(true);
                            setTimeout(() => setCopyFeedback(false), 2000);
                        } else {
                            alert("複製失敗 (Browser restrictions)");
                        }
                    } catch (err) {
                        alert("複製失敗");
                    }
                    document.body.removeChild(textArea);
                };

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            setCopyFeedback(true);
                            setTimeout(() => setCopyFeedback(false), 2000);
                        })
                        .catch(() => copyToClipboardFallback(text));
                } else {
                    copyToClipboardFallback(text);
                }
            };

            // --- Logic: Stats & Sorting ---
            const getBenchPlayers = () => {
                const boatPlayerIds = new Set();
                if (boat.drummer) boatPlayerIds.add(boat.drummer.id);
                if (boat.steers) boatPlayerIds.add(boat.steers.id);
                boat.left.forEach(p => p && boatPlayerIds.add(p.id));
                boat.right.forEach(p => p && boatPlayerIds.add(p.id));
                
                const bench = roster.filter(p => !boatPlayerIds.has(p.id));
                
                return bench.sort((a, b) => {
                    const sideOrder = { 'L': 1, 'R': 2, 'B': 3 };
                    if (sideOrder[a.side] !== sideOrder[b.side]) {
                        return sideOrder[a.side] - sideOrder[b.side];
                    }
                    return b.weight - a.weight; 
                });
            };

            const calculateStats = () => {
                let leftW = 0, rightW = 0, maleCount = 0, femaleCount = 0;
                const processPlayer = (p, side) => {
                    if (!p) return;
                    if (side === 'left') leftW += p.weight;
                    if (side === 'right') rightW += p.weight;
                    if (p.gender === 'M') maleCount++;
                    if (p.gender === 'F') femaleCount++;
                };
                processPlayer(boat.drummer, 'center');
                processPlayer(boat.steers, 'center');
                boat.left.forEach(p => processPlayer(p, 'left'));
                boat.right.forEach(p => processPlayer(p, 'right'));
                return { leftW, rightW, diff: leftW - rightW, maleCount, femaleCount };
            };
            const stats = calculateStats();

            // --- Interaction ---
            const handleTapPlayer = (sourceType, index, side, playerData) => {
                if (selectedSource && selectedSource.data.id === playerData.id) {
                    setSelectedSource(null);
                    return;
                }
                if (selectedSource) {
                    executeMove(selectedSource, { type: sourceType, index, side, data: playerData });
                } else {
                    setSelectedSource({ type: sourceType, index, side, data: playerData });
                    if (sourceType === 'roster') setIsBenchOpen(false);
                }
            };

            const handleTapEmptySlot = (targetType, index, side) => {
                if (selectedSource) {
                    executeMove(selectedSource, { type: targetType, index, side, data: null });
                }
            };

            const executeMove = (source, target) => {
                const newBoat = JSON.parse(JSON.stringify(boat));
                const placePlayer = (player, location) => {
                    if (location.type === 'boat') {
                        if (location.side === 'drummer') newBoat.drummer = player;
                        else if (location.side === 'steers') newBoat.steers = player;
                        else if (location.side === 'left') newBoat.left[location.index] = player;
                        else if (location.side === 'right') newBoat.right[location.index] = player;
                    }
                };
                const clearLocation = (location) => {
                    if (location.type === 'boat') {
                        if (location.side === 'drummer') newBoat.drummer = null;
                        else if (location.side === 'steers') newBoat.steers = null;
                        else if (location.side === 'left') newBoat.left[location.index] = null;
                        else if (location.side === 'right') newBoat.right[location.index] = null;
                    }
                };
                if (source.type === 'roster' && target.type === 'boat' && !target.data) {
                    placePlayer(source.data, target);
                } else if (source.type === 'boat' && target.type === 'boat') {
                    const sourcePlayer = source.data;
                    const targetPlayer = target.data;
                    placePlayer(sourcePlayer, target);
                    if (targetPlayer) placePlayer(targetPlayer, source);
                    else clearLocation(source);
                }
                updateCurrentBoat(newBoat);
                setSelectedSource(null);
            };

            const handleKickToBench = () => {
                if (!selectedSource || selectedSource.type !== 'boat') return;
                const newBoat = { ...boat };
                if (selectedSource.side === 'drummer') newBoat.drummer = null;
                else if (selectedSource.side === 'steers') newBoat.steers = null;
                else if (selectedSource.side === 'left') newBoat.left[selectedSource.index] = null;
                else if (selectedSource.side === 'right') newBoat.right[selectedSource.index] = null;
                updateCurrentBoat(newBoat);
                setSelectedSource(null);
            };

            // --- Components ---
            const PlayerCard = ({ player, isSelected, onClick, context = 'bench', sideConstraint = null }) => {
                const isConflict = context === 'boat' && sideConstraint && player.side !== 'B' && player.side !== sideConstraint;
                
                return (
                    <div 
                        onClick={onClick}
                        className={`
                            relative flex items-center justify-between px-1 rounded border transition-all cursor-pointer select-none overflow-hidden
                            ${isSelected ? 'border-blue-500 bg-blue-100 shadow-sm z-10' : 'border-gray-200 bg-white hover:border-gray-300'}
                            ${isConflict ? 'border-red-500 bg-red-50' : ''}
                            active:scale-95
                        `}
                        style={{ height: '20px' }} 
                    >
                        <div className="flex items-center gap-1 overflow-hidden flex-1 h-full">
                            <div className={`
                                w-1 h-full shrink-0
                                ${player.side === 'L' ? 'bg-blue-500' : player.side === 'R' ? 'bg-red-500' : 'bg-purple-500'}
                            `}></div>
                            <span className="font-bold truncate text-gray-800 text-[11px] leading-none pt-[1px]">{player.name}</span>
                        </div>
                        <div className="flex items-center gap-0.5 shrink-0 pl-1">
                            <div className={`w-1.5 h-1.5 rounded-full ${player.gender === 'F' ? 'bg-pink-400' : 'bg-blue-400'}`}></div>
                            <span className="text-[9px] font-bold text-gray-400 leading-none">{player.weight}</span>
                        </div>
                        {isConflict && <AlertTriangle size={10} className="text-red-500 absolute top-0.5 right-0.5" />}
                    </div>
                );
            };

            const EmptySlot = ({ label, onClick, isActive }) => (
                <div onClick={onClick} className={`h-[20px] rounded border border-dashed flex items-center justify-center text-[10px] text-gray-300 font-medium transition-colors cursor-pointer ${isActive ? 'border-blue-400 bg-blue-50 text-blue-600' : 'border-gray-200'}`}>
                    {label}
                </div>
            );

            return (
                <div className="flex flex-col h-screen bg-gray-50 font-sans overflow-hidden">
                    
                    {/* --- Top Bar --- */}
                    <div className="bg-white border-b border-gray-200 px-2 pt-2 flex gap-1 overflow-x-auto no-scrollbar shrink-0 h-[38px] items-end">
                        {lineups.map(l => (
                            <button
                                key={l.id}
                                onClick={() => setActiveLineupId(l.id)}
                                className={`px-2 py-1 text-[11px] font-bold rounded-t-lg whitespace-nowrap border-t border-l border-r relative top-[1px] ${activeLineupId === l.id ? 'bg-gray-100 text-blue-700 border-gray-300 z-10' : 'bg-gray-50 text-gray-400 border-transparent hover:bg-gray-100'}`}
                            >
                                {l.name}
                            </button>
                        ))}
                        <button onClick={handleAddLineup} className="p-1 mb-1 text-gray-400 hover:text-blue-600"><Plus size={14} /></button>
                    </div>

                    {/* --- Sub Header --- */}
                    <div className="bg-gray-100 px-2 py-1.5 shadow-sm shrink-0">
                        <div className="flex justify-between items-center mb-1.5">
                            <div className="flex items-center gap-2">
                                {isEditNameMode ? (
                                    <input autoFocus className="text-xs font-bold bg-white border rounded px-1 w-24" value={currentLineup.name} onChange={(e) => updateLineupName(e.target.value)} onBlur={() => setIsEditNameMode(false)} />
                                ) : (
                                    <span onClick={() => setIsEditNameMode(true)} className="text-xs font-bold text-gray-800 border-b border-dashed border-gray-400 cursor-text">{currentLineup.name}</span>
                                )}
                            </div>
                            <div className="flex gap-1.5">
                                <button onClick={() => setImportModalOpen(true)} className="p-1.5 bg-white rounded border border-gray-300 text-gray-600 shadow-sm hover:bg-gray-50" title="匯入名單"><FileSpreadsheet size={14} /></button>
                                <button onClick={handleDuplicateLineup} className="p-1.5 bg-white rounded border border-gray-300 text-gray-600 shadow-sm hover:bg-gray-50" title="複製陣容"><Copy size={14} /></button>
                                <button onClick={requestDeleteLineup} disabled={lineups.length <= 1} className={`p-1.5 bg-white rounded border border-gray-300 shadow-sm ${lineups.length <= 1 ? 'text-gray-300' : 'text-red-500 hover:bg-red-50'}`} title="刪除"><Trash2 size={14} /></button>
                                <button onClick={handleCopyList} className={`p-1.5 text-white rounded border shadow-sm flex items-center gap-1 transition-colors ${copyFeedback ? 'bg-green-600 border-green-700' : 'bg-blue-600 border-blue-700 hover:bg-blue-700'}`} title="複製名單 (Excel)">
                                    {copyFeedback ? <Check size={14} /> : <ClipboardCopy size={14} />}
                                    <span className="text-[10px] font-bold">{copyFeedback ? "已複製" : "Excel"}</span>
                                </button>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <div className="bg-white rounded p-1 flex items-center justify-between shadow-sm border border-gray-200 h-6">
                                <div className="text-[9px] text-center w-1/3 text-blue-600 font-bold flex gap-1 justify-center leading-none"><span>L</span><span>{stats.leftW}</span></div>
                                <div className="text-[9px] text-center w-1/3 font-bold text-gray-500 flex items-center justify-center gap-1 leading-none">
                                    {stats.diff !== 0 && (stats.diff > 0 ? <ArrowUp size={8} className="text-blue-500"/> : <ArrowDown size={8} className="text-red-500"/>)}
                                    <span className={Math.abs(stats.diff) > 10 ? "text-red-500" : "text-gray-600"}>{Math.abs(stats.diff)}</span>
                                </div>
                                <div className="text-[9px] text-center w-1/3 text-red-600 font-bold flex gap-1 justify-center leading-none"><span>R</span><span>{stats.rightW}</span></div>
                            </div>
                            <div className="bg-white rounded p-1 px-2 flex items-center justify-between shadow-sm border border-gray-200 text-[10px] font-bold h-6">
                                <span className="text-pink-600">女 {stats.femaleCount}</span>
                                <span className="text-gray-300">|</span>
                                <span className="text-blue-600">男 {stats.maleCount}</span>
                            </div>
                        </div>
                    </div>

                    {/* --- Main Boat Area --- */}
                    <div className="flex-1 overflow-y-auto p-2 pb-24 relative bg-white" onClick={() => setIsBenchOpen(false)}>
                        <div className="absolute left-1/2 top-0 bottom-0 w-px bg-gray-100 -translate-x-1/2"></div>
                        <div className="max-w-[340px] mx-auto space-y-2 mt-1">
                            <div className="flex justify-center mb-1">
                                <div className="w-[158px] relative">
                                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 text-[8px] text-gray-300 font-bold">DRUMMER</div>
                                    {boat.drummer ? <PlayerCard player={boat.drummer} isSelected={selectedSource?.data?.id === boat.drummer.id} onClick={(e) => { e.stopPropagation(); handleTapPlayer('boat', 0, 'drummer', boat.drummer); }} context="boat" /> : <EmptySlot label="鼓手" isActive={selectedSource} onClick={(e) => { e.stopPropagation(); handleTapEmptySlot('boat', 0, 'drummer'); }} />}
                                </div>
                            </div>
                            {Array.from({ length: 10 }).map((_, rowIndex) => (
                                <div key={rowIndex} className="flex items-center gap-3">
                                    <div className="flex-1">
                                        {boat.left[rowIndex] ? <PlayerCard player={boat.left[rowIndex]} isSelected={selectedSource?.data?.id === boat.left[rowIndex].id} onClick={(e) => { e.stopPropagation(); handleTapPlayer('boat', rowIndex, 'left', boat.left[rowIndex]); }} context="boat" sideConstraint="L" /> : <EmptySlot label={`左${rowIndex + 1}`} isActive={selectedSource} onClick={(e) => { e.stopPropagation(); handleTapEmptySlot('boat', rowIndex, 'left'); }} />}
                                    </div>
                                    <div className="w-3 text-center text-[8px] text-gray-300 font-bold">{rowIndex + 1}</div>
                                    <div className="flex-1">
                                        {boat.right[rowIndex] ? <PlayerCard player={boat.right[rowIndex]} isSelected={selectedSource?.data?.id === boat.right[rowIndex].id} onClick={(e) => { e.stopPropagation(); handleTapPlayer('boat', rowIndex, 'right', boat.right[rowIndex]); }} context="boat" sideConstraint="R" /> : <EmptySlot label={`右${rowIndex + 1}`} isActive={selectedSource} onClick={(e) => { e.stopPropagation(); handleTapEmptySlot('boat', rowIndex, 'right'); }} />}
                                    </div>
                                </div>
                            ))}
                            <div className="flex justify-center mt-2 mb-4">
                                <div className="w-[158px] relative">
                                    <div className="absolute -bottom-3 left-1/2 -translate-x-1/2 text-[8px] text-gray-300 font-bold">STEERS</div>
                                    {boat.steers ? <PlayerCard player={boat.steers} isSelected={selectedSource?.data?.id === boat.steers.id} onClick={(e) => { e.stopPropagation(); handleTapPlayer('boat', 0, 'steers', boat.steers); }} context="boat" /> : <EmptySlot label="舵手" isActive={selectedSource} onClick={(e) => { e.stopPropagation(); handleTapEmptySlot('boat', 0, 'steers'); }} />}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* --- Drawer (Bench) --- */}
                    <div className={`fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.15)] z-40 rounded-t-xl border-t border-gray-200 transition-all duration-300 ease-in-out flex flex-col ${isBenchOpen ? 'h-[65vh]' : 'h-[40px]'}`}>
                        <div className="h-[40px] flex items-center justify-between px-3 cursor-pointer bg-white rounded-t-xl shrink-0 hover:bg-gray-50" onClick={() => setIsBenchOpen(!isBenchOpen)}>
                            <div className="flex items-center gap-2">
                                <div className="bg-gray-100 p-0.5 rounded-full">{isBenchOpen ? <ChevronDown size={14}/> : <ChevronUp size={14} />}</div>
                                <span className="font-bold text-gray-700 text-xs">待命板凳 ({getBenchPlayers().length})</span>
                            </div>
                            {selectedSource && selectedSource.type === 'boat' && <button onClick={(e) => { e.stopPropagation(); handleKickToBench(); }} className="bg-red-50 text-red-600 text-[9px] px-2 py-1 rounded border border-red-200">移回板凳</button>}
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 bg-slate-50 border-t border-gray-100">
                            <div className="grid grid-cols-3 gap-x-3 gap-y-3 pb-safe">
                                {getBenchPlayers().map(player => (
                                    <PlayerCard key={player.id} player={player} isSelected={selectedSource?.data?.id === player.id} onClick={(e) => { e.stopPropagation(); handleTapPlayer('roster', 0, null, player); }} context="bench" />
                                ))}
                                {getBenchPlayers().length === 0 && <div className="col-span-3 text-center text-gray-400 py-10 text-xs">全員上船！</div>}
                            </div>
                        </div>
                    </div>

                    {/* --- Import Modal (Enhanced V11) --- */}
                    {importModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl p-4 w-full max-w-sm animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-3 flex-none">
                                    <h3 className="font-bold text-gray-800 text-sm">匯入名單</h3>
                                    <button onClick={() => setImportModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X size={16}/></button>
                                </div>
                                <div className="text-[10px] text-gray-400 mb-2 bg-gray-50 p-2 rounded flex-none">
                                    格式：名字 角色(左/右/雙/舵/鼓) 性別 體重<br/>
                                    支援：空格、逗號、TAB、Excel 貼上
                                </div>
                                <textarea 
                                    className="w-full h-24 border border-gray-300 rounded p-2 text-xs mb-2 font-mono flex-none"
                                    placeholder="範例：王小明 左槳 男 75"
                                    value={importText}
                                    onChange={(e) => setImportText(e.target.value)}
                                />
                                
                                {/* Live Preview Section */}
                                <div className="flex-1 min-h-0 border border-gray-100 rounded mb-3 overflow-y-auto bg-slate-50">
                                    {importPreview.length > 0 ? (
                                        <table className="w-full text-[10px] text-left">
                                            <thead className="bg-gray-100 sticky top-0">
                                                <tr>
                                                    <th className="p-1 pl-2">名字</th>
                                                    <th className="p-1">位置</th>
                                                    <th className="p-1">性別</th>
                                                    <th className="p-1">體重</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {importPreview.map((p, i) => (
                                                    <tr key={i} className="border-b border-gray-100 last:border-0">
                                                        <td className="p-1 pl-2 font-bold">{p.name}</td>
                                                        <td className="p-1">
                                                            <span className={`px-1 rounded text-white ${p.side==='L'?'bg-blue-400':p.side==='R'?'bg-red-400':'bg-purple-400'}`}>
                                                                {p.side==='L'?'左':p.side==='R'?'右':'雙'}
                                                            </span>
                                                        </td>
                                                        <td className="p-1">{p.gender==='M'?'男':'女'}</td>
                                                        <td className="p-1">{p.weight}kg</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-gray-400 text-xs p-4">
                                            {importText ? "無法解析，請檢查格式" : "預覽區域"}
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-2 flex-none">
                                    <button onClick={() => setImportModalOpen(false)} className="px-3 py-2 text-xs font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200">取消</button>
                                    <button 
                                        onClick={() => handleImportSubmit('append')} 
                                        disabled={importPreview.length === 0}
                                        className="flex-1 py-2 text-xs font-bold text-white bg-green-600 rounded hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        新增 ({importPreview.length}人)
                                    </button>
                                    <button 
                                        onClick={() => handleImportSubmit('overwrite')} 
                                        disabled={importPreview.length === 0}
                                        className="flex-1 py-2 text-xs font-bold text-white bg-red-600 rounded hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        覆蓋
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- Delete Modal --- */}
                    {deleteModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl p-5 w-full max-w-xs animate-in zoom-in-95 duration-200">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-gray-800 text-base">確認刪除</h3>
                                    <button onClick={() => setDeleteModalOpen(false)} className="text-gray-400 hover:text-gray-600"><X size={18}/></button>
                                </div>
                                <p className="text-xs text-gray-600 mb-6 leading-relaxed">確定要刪除 <span className="font-bold text-gray-900">{currentLineup.name}</span> 嗎？<br/>此動作無法復原。</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setDeleteModalOpen(false)} className="flex-1 py-2 text-xs font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200">取消</button>
                                    <button onClick={confirmDeleteLineup} className="flex-1 py-2 text-xs font-bold text-white bg-red-600 rounded hover:bg-red-700 shadow-sm">確認刪除</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
